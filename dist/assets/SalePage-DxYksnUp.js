import{e as $,h as V,r as c,R as e,W as T,m as Q}from"./index-DsxBSm8k.js";import{P as z}from"./index-RQSmRrbC.js";function B(...t){const w=[],o=g=>{g&&w.push(String(g))},p=g=>{for(const d of g){const h=typeof d;if(d){if(h==="string"||h==="number"){o(d);continue}if(Array.isArray(d)){p(d);continue}if(h==="object")for(const m in d)Object.prototype.hasOwnProperty.call(d,m)&&d[m]&&o(m)}}};return p(t),w.join(" ")}function R(...t){return B(...t)}function K({product:t}){var k;const{add:w,map:o,updateQty:p,open:g,openCart:d}=$(),{notify:h}=V(),[m,r]=c.useState(0),[y,x]=c.useState(!1),A=c.useRef(null),P=c.useRef(null),q=c.useRef(null),D=Array.isArray(t.variants)&&t.variants.length>0,E=D?t.variants[Math.max(0,Math.min(m,t.variants.length-1))]:null,j=(E==null?void 0:E.price)??t.salePrice??t.price,f=c.useMemo(()=>(Array.isArray(t==null?void 0:t.images)?t.images:[]).map(a=>{var i;return typeof a=="string"?a:(a==null?void 0:a.url)||((i=a==null?void 0:a.asset)==null?void 0:i.url)||null}).filter(Boolean),[t]),v=f[0],u=f.slice(1),_=c.useMemo(()=>`variant-select-${t.id||"p"}`,[t.id]),M=()=>{var b;const l=(E==null?void 0:E.squareVariationId)||t.squareVariationId||null,a=`${t.id}:${l||""}`,i=((b=o==null?void 0:o[a])==null?void 0:b.qty)||0;t.inventoryManaged&&(typeof t.inventory=="number"?t.inventory:1/0)-i<=0||(w({productId:t.id,variationId:l,unitPrice:j,qty:1,title:t.title,image:v}),h("Added to cart",{actionLabel:g?void 0:"View cart",onAction:g?void 0:d}))},n=`${t.id}:${(E==null?void 0:E.squareVariationId)||t.squareVariationId||""}`,s=((k=o==null?void 0:o[n])==null?void 0:k.qty)||0,N=c.useMemo(()=>`$${(j/100).toFixed(2)}`,[j]);return c.useEffect(()=>{if(!y)return;q.current=document.activeElement;const l=A.current;if(P.current)try{P.current.focus()}catch{}const a=i=>{if(i.key==="Escape"){i.stopPropagation(),x(!1);return}if(i.key==="Tab"&&l){const b=l.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),C=Array.from(b).filter(O=>O.offsetParent!==null);if(C.length===0)return;const F=C[0],I=C[C.length-1];!i.shiftKey&&document.activeElement===I?(i.preventDefault(),F.focus()):i.shiftKey&&document.activeElement===F&&(i.preventDefault(),I.focus())}};return document.addEventListener("keydown",a,!0),()=>{document.removeEventListener("keydown",a,!0);const i=q.current;if(i&&i.focus)try{i.focus()}catch{}}},[y]),e.createElement("div",{className:R("group relative rounded-xl border border-neutral-200 bg-white shadow-sm overflow-hidden","transition hover:shadow-md")},e.createElement("div",{className:"relative aspect-[4/3] w-full bg-neutral-100 overflow-hidden cursor-pointer",role:"button",tabIndex:0,onClick:()=>x(!0),onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),x(!0))}},v?e.createElement(e.Fragment,null,e.createElement("img",{src:v,alt:t.title,loading:"lazy",className:R("absolute inset-0 h-full w-full object-cover",u[0]?"transition-opacity duration-300 opacity-100 group-hover:opacity-0":"")}),u[0]?e.createElement("img",{src:u[0],alt:"","aria-hidden":"true",loading:"lazy",className:"absolute inset-0 h-full w-full object-cover transition-opacity duration-300 opacity-0 group-hover:opacity-100"}):null,e.createElement("div",{className:R("pointer-events-none absolute inset-x-0 bottom-0 transition-opacity duration-200","opacity-0 group-hover:opacity-100 group-focus-within:opacity-100")},e.createElement("div",{className:"pointer-events-none bg-gradient-to-t from-black/70 to-transparent text-white p-3"},t.shortDescription?e.createElement("p",{className:"text-xs leading-snug line-clamp-2"},t.shortDescription):null))):e.createElement("div",{className:"w-full h-full grid place-items-center text-neutral-400"},"No image")),e.createElement("div",{className:"p-3"},e.createElement("div",{className:"flex items-baseline justify-between gap-3"},e.createElement("h3",{className:"text-base font-semibold leading-tight line-clamp-2"},e.createElement("button",{type:"button",className:"text-left w-full cursor-pointer hover:underline focus:outline-none",onClick:()=>x(!0)},t.title)),e.createElement("div",{className:"text-sm font-mono"},t.salePrice&&e.createElement("span",{className:"text-neutral-400 line-through mr-1"},"$",(t.price/100).toFixed(2)),e.createElement("span",{className:"text-rose-600 font-bold"},N))),t.shortDescription&&e.createElement("p",{className:"text-sm text-neutral-600 mt-1 line-clamp-2"},t.shortDescription),e.createElement("div",{className:"mt-3 flex gap-2 items-center"},D&&e.createElement("select",{className:"input",value:m,onChange:l=>r(Number(l.target.value)||0),"aria-label":"Choose a variant"},t.variants.map((l,a)=>e.createElement("option",{key:l.squareVariationId||l.name||a,value:a},l.name||`Option ${a+1}`))),s>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>p(n,Math.max(0,s-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},s),e.createElement("button",{className:"btn",onClick:()=>p(n,s+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:M,disabled:t.inventoryManaged&&(t.inventory??0)<=s,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=s,title:t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":"Add to cart"},t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":s>0?"Add one more":"Add to cart"))),y&&e.createElement("div",{className:"fixed inset-0 z-[60]","aria-hidden":!y},e.createElement("div",{className:"absolute inset-0 bg-black/50",onClick:()=>x(!1)}),e.createElement("div",{className:"absolute inset-x-3 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 top-10 bottom-10 md:top-1/2 md:-translate-y-1/2 md:bottom-auto w-auto md:w-[720px] max-w-[95vw]",role:"dialog","aria-modal":"true","aria-labelledby":`product-dialog-title-${t.id}`,ref:A},e.createElement("div",{className:"bg-white rounded-xl shadow-2xl border overflow-hidden flex flex-col h-full md:h-auto"},e.createElement("div",{className:"flex items-start justify-between p-4 border-b"},e.createElement("h3",{id:`product-dialog-title-${t.id}`,className:"text-lg font-semibold"},t.title),e.createElement("button",{ref:P,className:"btn",onClick:()=>x(!1),"aria-label":"Close"},"✕")),e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-4 p-4 overflow-auto"},e.createElement("div",null,v?e.createElement("img",{src:v,alt:t.title,className:"w-full h-56 md:h-72 object-cover rounded"}):e.createElement("div",{className:"w-full h-56 md:h-72 grid place-items-center text-neutral-400 bg-neutral-100 rounded"},"No image"),u.length>0&&e.createElement("div",{className:"mt-2 grid grid-cols-4 gap-2"},[v,...u].slice(0,8).map((l,a)=>e.createElement("div",{key:a,className:"block"},e.createElement("img",{src:l,alt:"",className:"w-full h-16 object-cover rounded"}))))),e.createElement("div",null,e.createElement("div",{className:"text-xl font-semibold"},N),D&&e.createElement("div",{className:"mt-3"},e.createElement("label",{className:"block text-sm font-medium mb-1",htmlFor:_},"Choose an option"),e.createElement("select",{className:"input w-full",id:_,value:m,onChange:l=>r(Number(l.target.value)||0)},t.variants.map((l,a)=>e.createElement("option",{key:l.squareVariationId||l.name||a,value:a},l.name||`Option ${a+1}`)))),Array.isArray(t.longDescriptionBlocks)&&t.longDescriptionBlocks.length>0?e.createElement("div",{className:"prose prose-sm mt-4 max-w-none"},e.createElement(z,{value:t.longDescriptionBlocks})):t.longDescription?e.createElement("p",{className:"text-sm text-neutral-700 mt-4 whitespace-pre-wrap"},t.longDescription):null,e.createElement("div",{className:"mt-6 flex gap-2 items-center"},s>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>p(n,Math.max(0,s-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},s),e.createElement("button",{className:"btn",onClick:()=>p(n,s+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:M,disabled:t.inventoryManaged&&(t.inventory??0)<=s,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=s},t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":s>0?"Add one more":"Add to cart"))))))))}function U(){const{items:t,subtotal:w,open:o,closeCart:p,clear:g}=$(),[d,h]=c.useState(!1),[m,r]=c.useState(""),[y,x]=c.useState(""),[A,P]=c.useState(""),[q,D]=c.useState(!0),[E,j]=c.useState(""),[f,v]=c.useState({line1:"",line2:"",city:"",state:"",postal:""}),u=e.useRef(null),_=e.useRef(null);e.useEffect(()=>{var k,l,a,i;const n=((l=(k=import.meta)==null?void 0:k.env)==null?void 0:l.VITE_SQUARE_APP_ID)||(window==null?void 0:window.__SQUARE_APP_ID__),s=((i=(a=import.meta)==null?void 0:a.env)==null?void 0:i.VITE_SQUARE_LOCATION_ID)||(window==null?void 0:window.__SQUARE_LOCATION_ID__);if(!o||!t||t.length===0)return;if(r(""),!n||!s){r("Square not configured");return}let N=!1;return(async()=>{try{if(document.getElementById("sq-wpsdk")||await new Promise((I,O)=>{const S=document.createElement("script");S.id="sq-wpsdk",S.src="https://web.squarecdn.com/v1/square.js",S.onload=I,S.onerror=()=>O(new Error("Square SDK failed")),document.head.appendChild(S)}),N)return;await new Promise((I,O)=>{let S=0;const L=setInterval(()=>{S++,window.Square&&typeof window.Square.payments=="function"?(clearInterval(L),I()):S>50&&(clearInterval(L),O(new Error("Square SDK not ready")))},100)});const C=window.Square?window.Square.payments(n,s):null;if(!C)throw new Error("Square payments unavailable");if(u.current&&typeof u.current.destroy=="function"){try{u.current.destroy()}catch{}u.current=null}const F=await C.card();u.current=F,_.current&&await F.attach("#sq-card")}catch(b){r(b!=null&&b.message?`Payment form failed: ${b.message}`:"Payment form failed to load")}})(),()=>{N=!0}},[o,t]),e.useEffect(()=>{if(!o&&u.current&&typeof u.current.destroy=="function"){try{u.current.destroy()}catch{}u.current=null}},[o]);const M=async n=>{var s;n.preventDefault(),h(!0),r("");try{let N=null;if(u.current){const a=await u.current.tokenize();if(a.status!=="OK"){const i=(a==null?void 0:a.errors)&&((s=a.errors[0])==null?void 0:s.message)||(a==null?void 0:a.status)||"Card details invalid";throw new Error(i)}N=a.token}const k=await fetch("/api/store/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer:{name:y,email:A,phone:E},pickup:q,address:q?null:f,items:t.map(a=>({productId:a.productId,variationId:a.variationId,qty:a.qty,unitPrice:a.unitPrice,title:a.title})),token:N})}),l=await k.json();if(!k.ok)throw new Error(l.error||"Checkout failed");g(),p(),alert("Order placed!")}catch(N){r(N.message||"Checkout failed")}finally{h(!1)}};return o?e.createElement("div",{className:"fixed inset-0 bg-black/40 z-50"},e.createElement("div",{className:"absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-4 overflow-auto"},e.createElement("div",{className:"flex items-center justify-between mb-3"},e.createElement("h3",{className:"text-xl font-semibold"},"Your Cart"),e.createElement("button",{className:"btn",onClick:p},"Close")),t.length===0?e.createElement("p",{className:"text-sm text-neutral-600"},"Your cart is empty."):e.createElement(e.Fragment,null,e.createElement("ul",{className:"divide-y"},t.map(n=>e.createElement("li",{key:n.key,className:"py-2 flex items-center gap-3"},n.image&&e.createElement("img",{src:n.image,alt:"",className:"w-12 h-12 object-cover rounded"}),e.createElement("div",{className:"flex-1"},e.createElement("div",{className:"font-medium text-sm"},n.title),e.createElement("div",{className:"text-xs text-neutral-600"},"Qty ",n.qty," • $",(n.unitPrice/100).toFixed(2)))))),e.createElement("div",{className:"mt-4 border-t pt-3"},e.createElement("div",{className:"flex justify-between text-sm"},e.createElement("span",null,"Subtotal"),e.createElement("span",null,"$",(w/100).toFixed(2))),e.createElement("p",{className:"text-xs text-neutral-500 mt-1"},"Tax calculated by Square.")),e.createElement("form",{onSubmit:M,className:"mt-4 space-y-3"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-name"},"Name"),e.createElement("input",{id:"co-name",className:"input w-full",value:y,onChange:n=>x(n.target.value),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-email"},"Email"),e.createElement("input",{id:"co-email",type:"email",className:"input w-full",value:A,onChange:n=>P(n.target.value),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-phone"},"Phone"),e.createElement("input",{id:"co-phone",type:"tel",className:"input w-full",value:E,onChange:n=>j(n.target.value)})),e.createElement("div",{className:"flex items-center gap-2 text-sm"},e.createElement("input",{id:"pickup",type:"checkbox",checked:q,onChange:n=>D(n.target.checked)}),e.createElement("label",{htmlFor:"pickup"},"Pickup / local service")),!q&&e.createElement("div",{className:"grid grid-cols-1 gap-2"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"addr1"},"Address line 1"),e.createElement("input",{id:"addr1",className:"input w-full",value:f.line1,onChange:n=>v({...f,line1:n.target.value}),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"addr2"},"Address line 2 (optional)"),e.createElement("input",{id:"addr2",className:"input w-full",value:f.line2,onChange:n=>v({...f,line2:n.target.value})})),e.createElement("div",{className:"grid grid-cols-2 gap-2"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"city"},"City"),e.createElement("input",{id:"city",className:"input w-full",value:f.city,onChange:n=>v({...f,city:n.target.value}),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"state"},"State"),e.createElement("input",{id:"state",className:"input w-full",value:f.state,onChange:n=>v({...f,state:n.target.value}),required:!0}))),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"zip"},"Postal code"),e.createElement("input",{id:"zip",className:"input w-full",value:f.postal,onChange:n=>v({...f,postal:n.target.value}),required:!0}))),e.createElement("div",{className:"rounded-md border p-3 text-sm text-neutral-600"},e.createElement("div",{id:"sq-card",ref:_,className:"min-h-[52px]"})),m&&e.createElement("div",{className:"text-sm text-red-600"},m),e.createElement("button",{type:"submit",className:"btn btn-primary w-full",disabled:d},d?"Processing…":"Checkout"))))):null}const W=()=>{const{totalQty:t,openCart:w}=$(),[o,p]=c.useState([]),[g,d]=c.useState(!0);c.useEffect(()=>{let m=!0;return(async()=>{try{const r=await fetch("/api/store/products"),y=r.ok?await r.json():{products:[]};if(!m)return;p(Array.isArray(y.products)?y.products:[])}catch{if(!m)return;p([])}finally{m&&d(!1)}})(),()=>{m=!1}},[]);const h=c.useMemo(()=>({"@context":"https://schema.org","@type":"ItemList",name:"Sale",itemListElement:(o||[]).map((r,y)=>({"@type":"ListItem",position:y+1,item:{"@type":"Product",name:r.title,image:Array.isArray(r.images)?r.images.filter(Boolean):r.images?[r.images]:[],description:r.shortDescription,sku:r.squareVariationId||r.squareItemId||r.id,offers:{"@type":"Offer",priceCurrency:"USD",price:(r.salePrice??r.price)/100,availability:"https://schema.org/InStock"}}}))}),[o]);return e.createElement("div",{className:"mx-auto max-w-6xl px-4 md:px-6 lg:px-8 py-8"},e.createElement(T,null,e.createElement("title",null,"SALE | Local Effort"),e.createElement("meta",{name:"description",content:"Shop Local Effort sale items. Pickup/local service with on-site checkout."}),e.createElement("script",{type:"application/ld+json"},JSON.stringify(h))),e.createElement("div",{className:"flex items-center justify-between mb-6"},e.createElement("h1",{className:"text-3xl font-bold tracking-tight"},"Sale"),e.createElement("button",{onClick:w,className:"btn btn-primary"},"Cart (",t,")")),g?e.createElement("div",null,"Loading…"):e.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"},(o||[]).map(m=>e.createElement(Q.div,{key:m.id,initial:{opacity:0,y:8},whileInView:{opacity:1,y:0},viewport:{once:!0}},e.createElement(K,{product:m})))),e.createElement(U,null))};export{W as default};
