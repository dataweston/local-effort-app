import{g as nt,d as it,r as y,R as n,P as w,W as ot,c as tt}from"./index-BB2wScGM.js";import{P as R}from"./index-CVnwnSTj.js";var at={exports:{}};(function(s,I){(function(P,z){s.exports=z()})(it,function(){function P(t,a){(a==null||a>t.length)&&(a=t.length);for(var r=0,e=Array(a);r<a;r++)e[r]=t[r];return e}function z(t,a){var r=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=k(t))||a){r&&(t=r);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function p(){return p=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var r=arguments[a];for(var e in r)({}).hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t},p.apply(null,arguments)}function k(t,a){if(t){if(typeof t=="string")return P(t,a);var r={}.toString.call(t).slice(8,-1);return r==="Object"&&t.constructor&&(r=t.constructor.name),r==="Map"||r==="Set"?Array.from(t):r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?P(t,a):void 0}}var S="image-Tb9Ew8CXIwaY6R1kjMvI0uRR-2000x3000-jpg";function J(t){var a=t.split("-"),r=a[1],e=a[2],u=a[3];if(!r||!e||!u)throw new Error("Malformed asset _ref '"+t+`'. Expected an id like "`+S+'".');var o=e.split("x"),c=o[0],m=o[1],g=+c,f=+m,h=isFinite(g)&&isFinite(f);if(!h)throw new Error("Malformed asset _ref '"+t+`'. Expected an id like "`+S+'".');return{id:r,width:g,height:f,format:u}}var D=function(a){var r=a;return r?typeof r._ref=="string":!1},$=function(a){var r=a;return r?typeof r._id=="string":!1},B=function(a){var r=a;return r&&r.asset?typeof r.asset.url=="string":!1},V=function(a){if(typeof a=="object"&&a!==null){var r=a;return r._upload&&(!r.asset||!r.asset._ref)}return!1};function W(t){if(!t)return null;var a;if(typeof t=="string"&&Y(t))a={asset:{_ref:T(t)}};else if(typeof t=="string")a={asset:{_ref:t}};else if(D(t))a={asset:t};else if($(t))a={asset:{_ref:t._id||""}};else if(B(t))a={asset:{_ref:T(t.asset.url)}};else if(typeof t.asset=="object")a=p({},t);else return null;var r=t;return r.crop&&(a.crop=r.crop),r.hotspot&&(a.hotspot=r.hotspot),K(a)}function Y(t){return/^https?:\/\//.test(""+t)}function T(t){var a=t.split("/").slice(-1);return("image-"+a[0]).replace(/\.([a-z]+)$/,"-$1")}function K(t){if(t.crop&&t.hotspot)return t;var a=p({},t);return a.crop||(a.crop={left:0,top:0,bottom:0,right:0}),a.hotspot||(a.hotspot={x:.5,y:.5,height:1,width:1}),a}var L=[["width","w"],["height","h"],["format","fm"],["download","dl"],["blur","blur"],["sharpen","sharp"],["invert","invert"],["orientation","or"],["minHeight","min-h"],["maxHeight","max-h"],["minWidth","min-w"],["maxWidth","max-w"],["quality","q"],["fit","fit"],["crop","crop"],["saturation","sat"],["auto","auto"],["dpr","dpr"],["pad","pad"],["frame","frame"]];function X(t){var a=p({},t||{}),r=a.source;delete a.source;var e=W(r);if(!e){if(r&&V(r))return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8HwQACfsD/QNViZkAAAAASUVORK5CYII=";throw new Error("Unable to resolve image URL from source ("+JSON.stringify(r)+")")}var u=e.asset._ref||e.asset._id||"",o=J(u),c=Math.round(e.crop.left*o.width),m=Math.round(e.crop.top*o.height),g={left:c,top:m,width:Math.round(o.width-e.crop.right*o.width-c),height:Math.round(o.height-e.crop.bottom*o.height-m)},f=e.hotspot.height*o.height/2,h=e.hotspot.width*o.width/2,x=e.hotspot.x*o.width,N=e.hotspot.y*o.height,b={left:x-h,top:N-f,right:x+h,bottom:N+f};return a.rect||a.focalPoint||a.ignoreImageParams||a.crop||(a=p({},a,Z({crop:g,hotspot:b},a))),H(p({},a,{asset:o}))}function H(t){var a=(t.baseUrl||"https://cdn.sanity.io").replace(/\/+$/,""),r=t.vanityName?"/"+t.vanityName:"",e=t.asset.id+"-"+t.asset.width+"x"+t.asset.height+"."+t.asset.format+r,u=a+"/images/"+t.projectId+"/"+t.dataset+"/"+e,o=[];if(t.rect){var c=t.rect,m=c.left,g=c.top,f=c.width,h=c.height,x=m!==0||g!==0||h!==t.asset.height||f!==t.asset.width;x&&o.push("rect="+m+","+g+","+f+","+h)}t.bg&&o.push("bg="+t.bg),t.focalPoint&&(o.push("fp-x="+t.focalPoint.x),o.push("fp-y="+t.focalPoint.y));var N=[t.flipHorizontal&&"h",t.flipVertical&&"v"].filter(Boolean).join("");return N&&o.push("flip="+N),L.forEach(function(b){var O=b[0],i=b[1];typeof t[O]<"u"?o.push(i+"="+encodeURIComponent(t[O])):typeof t[i]<"u"&&o.push(i+"="+encodeURIComponent(t[i]))}),o.length===0?u:u+"?"+o.join("&")}function Z(t,a){var r,e=a.width,u=a.height;if(!(e&&u))return{width:e,height:u,rect:t.crop};var o=t.crop,c=t.hotspot,m=e/u,g=o.width/o.height;if(g>m){var f=Math.round(o.height),h=Math.round(f*m),x=Math.max(0,Math.round(o.top)),N=Math.round((c.right-c.left)/2+c.left),b=Math.max(0,Math.round(N-h/2));b<o.left?b=o.left:b+h>o.left+o.width&&(b=o.left+o.width-h),r={left:b,top:x,width:h,height:f}}else{var O=o.width,i=Math.round(O/m),l=Math.max(0,Math.round(o.left)),d=Math.round((c.bottom-c.top)/2+c.top),A=Math.max(0,Math.round(d-i/2));A<o.top?A=o.top:A+i>o.top+o.height&&(A=o.top+o.height-i),r={left:l,top:A,width:O,height:i}}return{width:e,height:u,rect:r}}var v=["clip","crop","fill","fillmax","max","scale","min"],j=["top","bottom","left","right","center","focalpoint","entropy"],G=["format"];function q(t){return t&&"config"in t?typeof t.config=="function":!1}function M(t){return t&&"clientConfig"in t?typeof t.clientConfig=="object":!1}function _(t){for(var a=L,r=z(a),e;!(e=r()).done;){var u=e.value,o=u[0],c=u[1];if(t===o||t===c)return o}return t}function U(t){if(q(t)){var a=t.config(),r=a.apiHost,e=a.projectId,u=a.dataset,o=r||"https://api.sanity.io";return new F(null,{baseUrl:o.replace(/^https:\/\/api\./,"https://cdn."),projectId:e,dataset:u})}if(M(t)){var c=t.clientConfig,m=c.apiHost,g=c.projectId,f=c.dataset,h=m||"https://api.sanity.io";return new F(null,{baseUrl:h.replace(/^https:\/\/api\./,"https://cdn."),projectId:g,dataset:f})}return new F(null,t||{})}var F=function(){function t(r,e){this.options=void 0,this.options=r?p({},r.options||{},e||{}):p({},e||{})}var a=t.prototype;return a.withOptions=function(e){var u=e.baseUrl||this.options.baseUrl,o={baseUrl:u};for(var c in e)if(e.hasOwnProperty(c)){var m=_(c);o[m]=e[c]}return new t(this,p({baseUrl:u},o))},a.image=function(e){return this.withOptions({source:e})},a.dataset=function(e){return this.withOptions({dataset:e})},a.projectId=function(e){return this.withOptions({projectId:e})},a.bg=function(e){return this.withOptions({bg:e})},a.dpr=function(e){return this.withOptions(e&&e!==1?{dpr:e}:{})},a.width=function(e){return this.withOptions({width:e})},a.height=function(e){return this.withOptions({height:e})},a.focalPoint=function(e,u){return this.withOptions({focalPoint:{x:e,y:u}})},a.maxWidth=function(e){return this.withOptions({maxWidth:e})},a.minWidth=function(e){return this.withOptions({minWidth:e})},a.maxHeight=function(e){return this.withOptions({maxHeight:e})},a.minHeight=function(e){return this.withOptions({minHeight:e})},a.size=function(e,u){return this.withOptions({width:e,height:u})},a.blur=function(e){return this.withOptions({blur:e})},a.sharpen=function(e){return this.withOptions({sharpen:e})},a.rect=function(e,u,o,c){return this.withOptions({rect:{left:e,top:u,width:o,height:c}})},a.format=function(e){return this.withOptions({format:e})},a.invert=function(e){return this.withOptions({invert:e})},a.orientation=function(e){return this.withOptions({orientation:e})},a.quality=function(e){return this.withOptions({quality:e})},a.forceDownload=function(e){return this.withOptions({download:e})},a.flipHorizontal=function(){return this.withOptions({flipHorizontal:!0})},a.flipVertical=function(){return this.withOptions({flipVertical:!0})},a.ignoreImageParams=function(){return this.withOptions({ignoreImageParams:!0})},a.fit=function(e){if(v.indexOf(e)===-1)throw new Error('Invalid fit mode "'+e+'"');return this.withOptions({fit:e})},a.crop=function(e){if(j.indexOf(e)===-1)throw new Error('Invalid crop mode "'+e+'"');return this.withOptions({crop:e})},a.saturation=function(e){return this.withOptions({saturation:e})},a.auto=function(e){if(G.indexOf(e)===-1)throw new Error('Invalid auto mode "'+e+'"');return this.withOptions({auto:e})},a.pad=function(e){return this.withOptions({pad:e})},a.vanityName=function(e){return this.withOptions({vanityName:e})},a.frame=function(e){if(e!==1)throw new Error('Invalid frame value "'+e+'"');return this.withOptions({frame:e})},a.url=function(){return X(this.options)},a.toString=function(){return this.url()},t}();return U})})(at);var st=at.exports;const lt=nt(st),ct=lt(tt);function ut(s){return ct.image(s)}const et=({value:s,label:I})=>n.createElement("div",null,n.createElement("p",{className:"text-3xl font-bold"},s),n.createElement("p",{className:"text-gray-600"},I));et.propTypes={value:w.oneOfType([w.string,w.number]).isRequired,label:w.string.isRequired};const rt=({tier:s,onContribute:I,busy:P})=>{if(!s)return null;const z=s.pieCount?`${s.pieCount.toLocaleString()} pies`:null,p=s.pizzaCount?`${s.pizzaCount.toLocaleString()} pizzas`:null,k=s.amount?`$${s.amount.toLocaleString()}`:null;return n.createElement("div",{className:"card p-6 border hover:border-[var(--color-accent)] transition-colors"},n.createElement("p",{className:"text-2xl font-bold"},z?`${z} — ${s.title}`:p?`${p} — ${s.title}`:`Pledge ${k||"$0"} or more`),!p&&n.createElement("h4",{className:"text-xl font-bold text-[var(--color-accent)] mt-1"},s.title),n.createElement("p",{className:"text-body text-gray-600 my-3"},s.description),s.limit&&n.createElement("p",{className:"text-sm font-semibold text-gray-500 mb-3"},"LIMITED (",s.limit," left)"),n.createElement("button",{className:"btn btn-secondary w-full disabled:opacity-60",disabled:P||!(typeof s.amount=="number"&&s.amount>0),onClick:()=>{typeof s.amount=="number"&&s.amount>0&&I({name:s.title||"Pledge",price:s.amount})}},typeof s.amount=="number"?"Select this reward":"Unavailable online"))};rt.propTypes={tier:w.shape({pizzaCount:w.number,pieCount:w.number,amount:w.number,title:w.string,description:w.string,limit:w.number})};const mt=()=>{var O;const[s,I]=y.useState(null),[P,z]=y.useState(!0),[p,k]=y.useState(null),[S,J]=y.useState("story"),[D,$]=y.useState(!1),[B,V]=y.useState(""),[W,Y]=y.useState(""),[T,K]=y.useState(1),[L,X]=y.useState(""),[H,Z]=y.useState(""),[v,j]=y.useState({status:"idle",valid:!1,participant:null,code:""});y.useEffect(()=>{const i="local-pizza-by-local-effort-let-s-make-1000-pizzas",l=`*[_type == "crowdfundingCampaign" && slug.current == $slug][0]{
      title,
      // Short description: prefer new field name, fallback to legacy if present
      "description": coalesce(description, shortDescription),
      // pizza-specific fields (keep legacy fields for backwards compatibility)
      pizzaGoal,
      pizzasSold,
      piesSold,
      goal,
      raisedAmount,
      backers,
      endDate,
      heroImage,
      story,
      goals,
      faq,
  "rewardTiers": rewardTiers[]->{ amount, pizzaCount, pieCount, title, description, limit, referralOnly, referralCode } | order(amount asc),
      "updates": updates[]->{ title, publishedAt, body } | order(publishedAt desc)
    }`,d={slug:i};(async()=>{try{const E=await tt.fetch(l,d);I(E)}catch(E){try{const C=E&&E.message?E.message:String(E);if(console.error("Sanity fetch error message:",C),E&&E.response&&typeof E.response.text=="function"){const Q=await E.response.text();console.error("Sanity fetch response body:",Q)}}catch(C){console.error("Error while logging Sanity error:",C)}try{const Q=await tt.fetch(`*[_type == "crowdfundingCampaign"][0]{
            title,
            "description": coalesce(description, shortDescription),
            pizzaGoal,
            pizzasSold,
            piesSold,
            goal,
            raisedAmount,
            backers,
            endDate,
            heroImage,
            story,
            goals,
            faq,
            "rewardTiers": rewardTiers[]->{ amount, pizzaCount, pieCount, title, description, limit, referralOnly, referralCode } | order(amount asc),
            "updates": updates[]->{ title, publishedAt, body } | order(publishedAt desc)
          }`);if(Q){console.warn("Loaded fallback campaign (first in dataset)"),I(Q),k(null);return}}catch(C){console.error("Fallback fetch also failed:",C&&(C.message||C))}k("Failed to load campaign data.")}finally{z(!1)}})()},[]);const G=(s==null?void 0:s.rewardTiers)||[],q=y.useMemo(()=>{const i=v.valid&&v.code;return G.filter(l=>l!=null&&l.referralOnly?i?l.referralCode&&typeof l.referralCode=="string"?l.referralCode.trim().toLowerCase()===v.code.trim().toLowerCase():!0:!1:!0)},[G,v]),M=y.useMemo(()=>q.find(i=>typeof(i==null?void 0:i.amount)=="number"&&i.amount>0)||null,[q]);if(y.useEffect(()=>{new URLSearchParams(window.location.search).get("payment")==="success"&&(async()=>{try{const l=localStorage.getItem("cf_items"),d=l?JSON.parse(l):[],A=localStorage.getItem("cf_name")||void 0;Array.isArray(d)&&d.length>0&&(await fetch("/api/crowdfund/confirm-payment",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:d,funderName:A})})).ok&&X("Thanks! Your contribution has been recorded.")}catch{}finally{try{localStorage.removeItem("cf_items"),localStorage.removeItem("cf_name")}catch{}}})()},[]),P)return n.createElement("div",{className:"text-center p-12"},"Loading campaign...");if(p){const i=typeof p=="string"?p:p&&(p.message||JSON.stringify(p))||"Failed to load campaign data.";return n.createElement("div",{className:"text-center p-12 text-red-600"},i)}if(!s)return n.createElement("div",{className:"text-center p-12"},"No campaign found. Have you created and published it in Sanity Studio?");const{title:_="Untitled Campaign",description:U=[],backers:F=0,endDate:t=null,heroImage:a=null}=s,r=s.piesSold??0,e=s.story||[],u=s.faq||[],o=async i=>{V(""),$(!0);try{try{localStorage.setItem("cf_items",JSON.stringify(i)),localStorage.setItem("cf_name",W||"")}catch{}const l=await fetch("/api/crowdfund/contribute",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:i})}),d=await l.json();if(!l.ok||!(d!=null&&d.url))throw new Error((d==null?void 0:d.error)||"Failed to create checkout");window.location.href=d.url}catch(l){V((l==null?void 0:l.message)||"Payment link failed")}finally{$(!1)}},c=s.updates||[],m=(s.pizzasSold??s.raisedAmount)||0,g=(s.pizzaGoal??s.goal)||1e3,f=t?Math.ceil((new Date(t)-new Date)/(1e3*60*60*24)):0,h=g>0?Math.min(m/g*100,100):0,x=({tabName:i,label:l})=>n.createElement("button",{type:"button",onClick:()=>J(i),"aria-pressed":S===i,className:`pb-2 px-1 text-lg font-semibold transition-colors ${S===i?"border-b-2 border-[var(--color-accent)] text-gray-900":"text-gray-500 hover:text-gray-800"}`},l);x.propTypes={tabName:w.string.isRequired,label:w.string.isRequired};const N=i=>i?typeof i=="string"?i:(i||[]).filter(Boolean).map(l=>typeof l=="string"?l:l.children&&Array.isArray(l.children)?l.children.map(d=>d.text||"").join(""):"").join(`
`).trim():"",b=i=>Array.isArray(i)?i:i?[{_type:"block",style:"normal",children:[{_type:"span",text:typeof i=="string"?i:String(i)}]}]:[];return n.createElement(n.Fragment,null,n.createElement(ot,null,n.createElement("title",null,`${_} | Crowdfunding Campaign`),n.createElement("meta",{name:"description",content:N(U).slice(0,160)})),n.createElement("div",{className:"space-y-16 mx-auto max-w-6xl px-4 md:px-6 lg:px-8"},n.createElement("div",null,n.createElement("h1",{className:"text-4xl md:text-6xl font-bold uppercase tracking-[-0.02em] leading-[1.02]"},_),n.createElement("div",{className:"mt-6 md:mt-8 text-body max-w-2xl"},U&&(Array.isArray(U)?n.createElement(R,{value:U}):n.createElement(R,{value:b(U)})))),n.createElement("div",{className:"grid grid-cols-1 lg:grid-cols-5 lg:gap-16"},n.createElement("div",{className:"lg:col-span-3 space-y-8"},a&&n.createElement("img",{src:ut(a).width(1200).quality(80).url(),alt:_,className:"w-full object-cover rounded-lg aspect-video bg-gray-100"}),n.createElement("div",{className:"border-b border-gray-200"},n.createElement("nav",{className:"flex space-x-8"},n.createElement(x,{tabName:"story",label:"Our Story"}),c.length>0&&n.createElement(x,{tabName:"updates",label:`Updates (${c.length})`}),n.createElement(x,{tabName:"goals",label:"Goals"}),u.length>0&&n.createElement(x,{tabName:"faq",label:"FAQ"}))),n.createElement("div",{className:"prose max-w-none text-body"},S==="story"&&e.length>0&&n.createElement(R,{value:e}),S==="updates"&&n.createElement("div",{className:"space-y-8"},c.map((i,l)=>n.createElement("div",{key:l,className:"p-4 border-l-4 border-gray-200"},n.createElement("h3",{className:"text-heading mt-0"},i.title),n.createElement("p",{className:"text-sm text-gray-500 mb-2"},new Date(i.publishedAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})),n.createElement(R,{value:i.body})))),S==="goals"&&n.createElement("div",{className:"space-y-6"},s.goals?Array.isArray(s.goals)?n.createElement(R,{value:s.goals}):n.createElement(R,{value:b(s.goals)}):n.createElement("p",{className:"text-gray-500"},"No goals content yet. Add content in the Goals field in Sanity Studio.")),S==="faq"&&n.createElement("div",{className:"space-y-6"},u.map((i,l)=>n.createElement("div",{key:l},n.createElement("h4",{className:"font-bold text-lg mb-1"},i.question),n.createElement("p",{className:"mt-0"},i.answer)))))),n.createElement("div",{className:"lg:col-span-2 space-y-8 mt-12 lg:mt-0"},n.createElement("div",{className:"card p-6 space-y-4"},n.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2.5"},n.createElement("div",{className:"bg-[var(--color-accent)] h-2.5 rounded-full",style:{width:`${h}%`}})),n.createElement("div",null,n.createElement("p",{className:"text-4xl font-bold text-[var(--color-accent)]"},m.toLocaleString()," pizzas"),n.createElement("p",{className:"text-body text-gray-600"},"sold of ",g.toLocaleString()," pizzas goal"),n.createElement("p",{className:"mt-2 text-2xl font-semibold"},r.toLocaleString()," pies"),n.createElement("p",{className:"text-body text-gray-600"},"sold")),n.createElement("div",{className:"flex justify-between text-body text-center border-y py-3"},n.createElement(et,{value:F.toLocaleString(),label:"backers"}),n.createElement(et,{value:f>0?f:"Ended",label:f>0?"days to go":""})),L&&n.createElement("p",{className:"text-sm text-emerald-700"},L),B&&n.createElement("p",{className:"text-sm text-red-600"},B),n.createElement("div",{className:"flex flex-col gap-2"},n.createElement("input",{id:"cf-name",className:"input w-full",placeholder:"Name",value:W,onChange:i=>Y(i.target.value)})),n.createElement("div",{className:"flex items-center gap-2"},n.createElement("input",{className:"input flex-1",placeholder:"Have a referral code?",value:H,onChange:i=>Z(i.target.value)}),n.createElement("button",{type:"button",className:"btn btn-secondary",disabled:!H||v.status==="checking",onClick:async()=>{const i=(H||"").trim();if(i){j({status:"checking",valid:!1,participant:null,code:i});try{const l=await fetch("/api/referrals/validate",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:i})}),d=await l.json().catch(()=>({}));l.ok&&d&&d.valid?j({status:"ok",valid:!0,participant:d.participant||null,code:i}):j({status:"ok",valid:!1,participant:null,code:i})}catch{j({status:"error",valid:!1,participant:null,code:i})}}}},v.status==="checking"?"Checking…":"Apply")),v.status==="ok"&&v.valid&&n.createElement("p",{className:"text-sm text-emerald-700"},"Code applied",(O=v.participant)!=null&&O.name?` for ${v.participant.name}`:"","."),v.status==="ok"&&!v.valid&&n.createElement("p",{className:"text-sm text-red-600"},"That code is not valid."),M&&n.createElement("div",{className:"flex items-center gap-3"},n.createElement("label",{htmlFor:"pizza-qty",className:"text-sm"},"Quantity"),n.createElement("input",{id:"pizza-qty",type:"number",min:1,max:50,value:T,onChange:i=>K(Math.max(1,Math.min(50,Number(i.target.value)||1))),className:"input w-24"})),n.createElement("button",{disabled:!M,onClick:()=>M&&o([{name:M.title||"Pizza",price:M.amount,type:"pizza",pizzaCount:T,quantity:T}]),className:"btn btn-primary w-full text-lg py-3 disabled:opacity-60"},D?"Preparing checkout…":"i want pizza")),n.createElement("div",{className:"space-y-4"},n.createElement("h3",{className:"text-heading uppercase"},"Support Us"),q.map(i=>n.createElement(rt,{key:(i==null?void 0:i.title)||Math.random(),tier:i,busy:D,onContribute:l=>o([l])})))))))};export{mt as default};
