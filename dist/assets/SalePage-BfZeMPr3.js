import{e as M,h as L,r as u,R as e,W as V,m as F}from"./index-DMXgV45R.js";import{P as T}from"./index-Bo31mduX.js";function Q(...t){const x=[],o=g=>{g&&x.push(String(g))},p=g=>{for(const f of g){const b=typeof f;if(f){if(b==="string"||b==="number"){o(f);continue}if(Array.isArray(f)){p(f);continue}if(b==="object")for(const m in f)Object.prototype.hasOwnProperty.call(f,m)&&f[m]&&o(m)}}};return p(t),x.join(" ")}function O(...t){return Q(...t)}function B({product:t}){var k;const{add:x,map:o,updateQty:p,open:g,openCart:f}=M(),{notify:b}=L(),[m,l]=u.useState(0),[v,w]=u.useState(!1),I=u.useRef(null),q=u.useRef(null),A=u.useRef(null),P=Array.isArray(t.variants)&&t.variants.length>0,i=P?t.variants[Math.max(0,Math.min(m,t.variants.length-1))]:null,C=(i==null?void 0:i.price)??t.salePrice??t.price,_=u.useMemo(()=>(Array.isArray(t==null?void 0:t.images)?t.images:[]).map(n=>{var s;return typeof n=="string"?n:(n==null?void 0:n.url)||((s=n==null?void 0:n.asset)==null?void 0:s.url)||null}).filter(Boolean),[t]),r=_[0],E=_.slice(1),N=u.useMemo(()=>`variant-select-${t.id||"p"}`,[t.id]),S=()=>{var h;const a=(i==null?void 0:i.squareVariationId)||t.squareVariationId||null,n=`${t.id}:${a||""}`,s=((h=o==null?void 0:o[n])==null?void 0:h.qty)||0;t.inventoryManaged&&(typeof t.inventory=="number"?t.inventory:1/0)-s<=0||(x({productId:t.id,variationId:a,unitPrice:C,qty:1,title:t.title,image:r}),b("Added to cart",{actionLabel:g?void 0:"View cart",onAction:g?void 0:f}))},d=`${t.id}:${(i==null?void 0:i.squareVariationId)||t.squareVariationId||""}`,c=((k=o==null?void 0:o[d])==null?void 0:k.qty)||0,D=u.useMemo(()=>`$${(C/100).toFixed(2)}`,[C]);return u.useEffect(()=>{if(!v)return;A.current=document.activeElement;const a=I.current;if(q.current)try{q.current.focus()}catch{}const n=s=>{if(s.key==="Escape"){s.stopPropagation(),w(!1);return}if(s.key==="Tab"&&a){const h=a.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),y=Array.from(h).filter($=>$.offsetParent!==null);if(y.length===0)return;const j=y[0],R=y[y.length-1];!s.shiftKey&&document.activeElement===R?(s.preventDefault(),j.focus()):s.shiftKey&&document.activeElement===j&&(s.preventDefault(),R.focus())}};return document.addEventListener("keydown",n,!0),()=>{document.removeEventListener("keydown",n,!0);const s=A.current;if(s&&s.focus)try{s.focus()}catch{}}},[v]),e.createElement("div",{className:O("group relative rounded-xl border border-neutral-200 bg-white shadow-sm overflow-hidden","transition hover:shadow-md")},e.createElement("div",{className:"relative aspect-[4/3] w-full bg-neutral-100 overflow-hidden cursor-pointer",role:"button",tabIndex:0,onClick:()=>w(!0),onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),w(!0))}},r?e.createElement(e.Fragment,null,e.createElement("img",{src:r,alt:t.title,loading:"lazy",className:O("absolute inset-0 h-full w-full object-cover",E[0]?"transition-opacity duration-300 opacity-100 group-hover:opacity-0":"")}),E[0]?e.createElement("img",{src:E[0],alt:"","aria-hidden":"true",loading:"lazy",className:"absolute inset-0 h-full w-full object-cover transition-opacity duration-300 opacity-0 group-hover:opacity-100"}):null,e.createElement("div",{className:O("pointer-events-none absolute inset-x-0 bottom-0 transition-opacity duration-200","opacity-0 group-hover:opacity-100 group-focus-within:opacity-100")},e.createElement("div",{className:"pointer-events-none bg-gradient-to-t from-black/70 to-transparent text-white p-3"},t.shortDescription?e.createElement("p",{className:"text-xs leading-snug line-clamp-2"},t.shortDescription):null))):e.createElement("div",{className:"w-full h-full grid place-items-center text-neutral-400"},"No image")),e.createElement("div",{className:"p-3"},e.createElement("div",{className:"flex items-baseline justify-between gap-3"},e.createElement("h3",{className:"text-base font-semibold leading-tight line-clamp-2"},e.createElement("button",{type:"button",className:"text-left w-full cursor-pointer hover:underline focus:outline-none",onClick:()=>w(!0)},t.title)),e.createElement("div",{className:"text-sm font-mono"},t.salePrice&&e.createElement("span",{className:"text-neutral-400 line-through mr-1"},"$",(t.price/100).toFixed(2)),e.createElement("span",{className:"text-rose-600 font-bold"},D))),t.shortDescription&&e.createElement("p",{className:"text-sm text-neutral-600 mt-1 line-clamp-2"},t.shortDescription),e.createElement("div",{className:"mt-3 flex gap-2 items-center"},P&&e.createElement("select",{className:"input",value:m,onChange:a=>l(Number(a.target.value)||0),"aria-label":"Choose a variant"},t.variants.map((a,n)=>e.createElement("option",{key:a.squareVariationId||a.name||n,value:n},a.name||`Option ${n+1}`))),c>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>p(d,Math.max(0,c-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},c),e.createElement("button",{className:"btn",onClick:()=>p(d,c+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:S,disabled:t.inventoryManaged&&(t.inventory??0)<=c,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=c,title:t.inventoryManaged&&(t.inventory??0)<=c?"Out of stock":"Add to cart"},t.inventoryManaged&&(t.inventory??0)<=c?"Out of stock":c>0?"Add one more":"Add to cart"))),v&&e.createElement("div",{className:"fixed inset-0 z-[60]","aria-hidden":!v},e.createElement("div",{className:"absolute inset-0 bg-black/50",onClick:()=>w(!1)}),e.createElement("div",{className:"absolute inset-x-3 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 top-10 bottom-10 md:top-1/2 md:-translate-y-1/2 md:bottom-auto w-auto md:w-[720px] max-w-[95vw]",role:"dialog","aria-modal":"true","aria-labelledby":`product-dialog-title-${t.id}`,ref:I},e.createElement("div",{className:"bg-white rounded-xl shadow-2xl border overflow-hidden flex flex-col h-full md:h-auto"},e.createElement("div",{className:"flex items-start justify-between p-4 border-b"},e.createElement("h3",{id:`product-dialog-title-${t.id}`,className:"text-lg font-semibold"},t.title),e.createElement("button",{ref:q,className:"btn",onClick:()=>w(!1),"aria-label":"Close"},"✕")),e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-4 p-4 overflow-auto"},e.createElement("div",null,r?e.createElement("img",{src:r,alt:t.title,className:"w-full h-56 md:h-72 object-cover rounded"}):e.createElement("div",{className:"w-full h-56 md:h-72 grid place-items-center text-neutral-400 bg-neutral-100 rounded"},"No image"),E.length>0&&e.createElement("div",{className:"mt-2 grid grid-cols-4 gap-2"},[r,...E].slice(0,8).map((a,n)=>e.createElement("div",{key:n,className:"block"},e.createElement("img",{src:a,alt:"",className:"w-full h-16 object-cover rounded"}))))),e.createElement("div",null,e.createElement("div",{className:"text-xl font-semibold"},D),P&&e.createElement("div",{className:"mt-3"},e.createElement("label",{className:"block text-sm font-medium mb-1",htmlFor:N},"Choose an option"),e.createElement("select",{className:"input w-full",id:N,value:m,onChange:a=>l(Number(a.target.value)||0)},t.variants.map((a,n)=>e.createElement("option",{key:a.squareVariationId||a.name||n,value:n},a.name||`Option ${n+1}`)))),Array.isArray(t.longDescriptionBlocks)&&t.longDescriptionBlocks.length>0?e.createElement("div",{className:"prose prose-sm mt-4 max-w-none"},e.createElement(T,{value:t.longDescriptionBlocks})):t.longDescription?e.createElement("p",{className:"text-sm text-neutral-700 mt-4 whitespace-pre-wrap"},t.longDescription):null,e.createElement("div",{className:"mt-6 flex gap-2 items-center"},c>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>p(d,Math.max(0,c-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},c),e.createElement("button",{className:"btn",onClick:()=>p(d,c+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:S,disabled:t.inventoryManaged&&(t.inventory??0)<=c,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=c},t.inventoryManaged&&(t.inventory??0)<=c?"Out of stock":c>0?"Add one more":"Add to cart"))))))))}function K(){const{items:t,subtotal:x,open:o,closeCart:p,clear:g}=M(),[f,b]=u.useState(!1),[m,l]=u.useState(""),[v,w]=u.useState(""),[I,q]=u.useState(""),[A,P]=u.useState(!0),i=e.useRef(null),C=e.useRef(null);e.useEffect(()=>{var S,d,c,D;const r=((d=(S=import.meta)==null?void 0:S.env)==null?void 0:d.VITE_SQUARE_APP_ID)||(window==null?void 0:window.__SQUARE_APP_ID__),E=((D=(c=import.meta)==null?void 0:c.env)==null?void 0:D.VITE_SQUARE_LOCATION_ID)||(window==null?void 0:window.__SQUARE_LOCATION_ID__);if(!o||!t||t.length===0)return;if(l(""),!r||!E){l("Square not configured");return}let N=!1;return(async()=>{try{if(document.getElementById("sq-wpsdk")||await new Promise((s,h)=>{const y=document.createElement("script");y.id="sq-wpsdk",y.src="https://web.squarecdn.com/v1/square.js",y.onload=s,y.onerror=()=>h(new Error("Square SDK failed")),document.head.appendChild(y)}),N)return;await new Promise((s,h)=>{let y=0;const j=setInterval(()=>{y++,window.Square&&typeof window.Square.payments=="function"?(clearInterval(j),s()):y>50&&(clearInterval(j),h(new Error("Square SDK not ready")))},100)});const a=window.Square?window.Square.payments(r,E):null;if(!a)throw new Error("Square payments unavailable");if(i.current&&typeof i.current.destroy=="function"){try{i.current.destroy()}catch{}i.current=null}const n=await a.card();i.current=n,C.current&&await n.attach("#sq-card")}catch(k){l(k!=null&&k.message?`Payment form failed: ${k.message}`:"Payment form failed to load")}})(),()=>{N=!0}},[o,t]),e.useEffect(()=>{if(!o&&i.current&&typeof i.current.destroy=="function"){try{i.current.destroy()}catch{}i.current=null}},[o]);const _=async r=>{r.preventDefault(),b(!0),l("");try{let E=null;if(i.current){const d=await i.current.tokenize();if(d.status!=="OK")throw new Error("Card tokenize failed");E=d.token}const N=await fetch("/api/store/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer:{name:v,email:I},pickup:A,items:t.map(d=>({productId:d.productId,variationId:d.variationId,qty:d.qty,unitPrice:d.unitPrice,title:d.title})),token:E})}),S=await N.json();if(!N.ok)throw new Error(S.error||"Checkout failed");g(),p(),alert("Order placed!")}catch(E){l(E.message||"Checkout failed")}finally{b(!1)}};return o?e.createElement("div",{className:"fixed inset-0 bg-black/40 z-50"},e.createElement("div",{className:"absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-4 overflow-auto"},e.createElement("div",{className:"flex items-center justify-between mb-3"},e.createElement("h3",{className:"text-xl font-semibold"},"Your Cart"),e.createElement("button",{className:"btn",onClick:p},"Close")),t.length===0?e.createElement("p",{className:"text-sm text-neutral-600"},"Your cart is empty."):e.createElement(e.Fragment,null,e.createElement("ul",{className:"divide-y"},t.map(r=>e.createElement("li",{key:r.key,className:"py-2 flex items-center gap-3"},r.image&&e.createElement("img",{src:r.image,alt:"",className:"w-12 h-12 object-cover rounded"}),e.createElement("div",{className:"flex-1"},e.createElement("div",{className:"font-medium text-sm"},r.title),e.createElement("div",{className:"text-xs text-neutral-600"},"Qty ",r.qty," • $",(r.unitPrice/100).toFixed(2)))))),e.createElement("div",{className:"mt-4 border-t pt-3"},e.createElement("div",{className:"flex justify-between text-sm"},e.createElement("span",null,"Subtotal"),e.createElement("span",null,"$",(x/100).toFixed(2))),e.createElement("p",{className:"text-xs text-neutral-500 mt-1"},"Tax calculated by Square.")),e.createElement("form",{onSubmit:_,className:"mt-4 space-y-3"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-name"},"Name"),e.createElement("input",{id:"co-name",className:"input w-full",value:v,onChange:r=>w(r.target.value),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-email"},"Email"),e.createElement("input",{id:"co-email",type:"email",className:"input w-full",value:I,onChange:r=>q(r.target.value),required:!0})),e.createElement("div",{className:"flex items-center gap-2 text-sm"},e.createElement("input",{id:"pickup",type:"checkbox",checked:A,onChange:r=>P(r.target.checked)}),e.createElement("label",{htmlFor:"pickup"},"Pickup / local service")),e.createElement("div",{className:"rounded-md border p-3 text-sm text-neutral-600"},e.createElement("div",{id:"sq-card",ref:C,className:"min-h-[52px]"})),m&&e.createElement("div",{className:"text-sm text-red-600"},m),e.createElement("button",{type:"submit",className:"btn btn-primary w-full",disabled:f},f?"Processing…":"Checkout"))))):null}const J=()=>{const{totalQty:t,openCart:x}=M(),[o,p]=u.useState([]),[g,f]=u.useState(!0);u.useEffect(()=>{let m=!0;return(async()=>{try{const l=await fetch("/api/store/products"),v=l.ok?await l.json():{products:[]};if(!m)return;p(Array.isArray(v.products)?v.products:[])}catch{if(!m)return;p([])}finally{m&&f(!1)}})(),()=>{m=!1}},[]);const b=u.useMemo(()=>({"@context":"https://schema.org","@type":"ItemList",name:"Sale",itemListElement:(o||[]).map((l,v)=>({"@type":"ListItem",position:v+1,item:{"@type":"Product",name:l.title,image:Array.isArray(l.images)?l.images.filter(Boolean):l.images?[l.images]:[],description:l.shortDescription,sku:l.squareVariationId||l.squareItemId||l.id,offers:{"@type":"Offer",priceCurrency:"USD",price:(l.salePrice??l.price)/100,availability:"https://schema.org/InStock"}}}))}),[o]);return e.createElement("div",{className:"mx-auto max-w-6xl px-4 md:px-6 lg:px-8 py-8"},e.createElement(V,null,e.createElement("title",null,"SALE | Local Effort"),e.createElement("meta",{name:"description",content:"Shop Local Effort sale items. Pickup/local service with on-site checkout."}),e.createElement("script",{type:"application/ld+json"},JSON.stringify(b))),e.createElement("div",{className:"flex items-center justify-between mb-6"},e.createElement("h1",{className:"text-3xl font-bold tracking-tight"},"Sale"),e.createElement("button",{onClick:x,className:"btn btn-primary"},"Cart (",t,")")),g?e.createElement("div",null,"Loading…"):e.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"},(o||[]).map(m=>e.createElement(F.div,{key:m.id,initial:{opacity:0,y:8},whileInView:{opacity:1,y:0},viewport:{once:!0}},e.createElement(B,{product:m})))),e.createElement(K,null))};export{J as default};
