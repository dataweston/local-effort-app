import{r as l,R as e,P as s,W as ne,c as P}from"./index-CUxUiH5k.js";import{P as p}from"./index-RHiQEz9r.js";import{i as le}from"./image-url.umd-B0yE27Pz.js";import{S as H}from"./SectionHeader-CmMNu3BY.js";const se=le(P);function oe(a){return se.image(a)}const L=({value:a,label:d})=>e.createElement("div",null,e.createElement("p",{className:"text-3xl font-bold"},a),e.createElement("p",{className:"text-gray-600"},d));L.propTypes={value:s.oneOfType([s.string,s.number]).isRequired,label:s.string.isRequired};const V=({tier:a,onContribute:d,busy:N})=>{if(!a)return null;const b=a.pieCount?`${a.pieCount.toLocaleString()} pies`:null,i=a.pizzaCount?`${a.pizzaCount.toLocaleString()} pizzas`:null,E=a.amount?`$${a.amount.toLocaleString()}`:null;return e.createElement("div",{className:"card p-6 border hover:border-[var(--color-accent)] transition-colors"},e.createElement("p",{className:"text-2xl font-bold"},b?`${b} — ${a.title}`:i?`${i} — ${a.title}`:`Pledge ${E||"$0"} or more`),!i&&e.createElement("h4",{className:"text-xl font-bold text-[var(--color-accent)] mt-1"},a.title),e.createElement("p",{className:"text-body text-gray-600 my-3"},a.description),a.limit&&e.createElement("p",{className:"text-sm font-semibold text-gray-500 mb-3"},"LIMITED (",a.limit," left)"),e.createElement("button",{className:"btn btn-secondary w-full disabled:opacity-60",disabled:N||!(typeof a.amount=="number"&&a.amount>0),onClick:()=>{typeof a.amount=="number"&&a.amount>0&&d({name:a.title||"Pledge",price:a.amount})}},typeof a.amount=="number"?"Select this reward":"Unavailable online"))};V.propTypes={tier:s.shape({pizzaCount:s.number,pieCount:s.number,amount:s.number,title:s.string,description:s.string,limit:s.number})};const pe=()=>{var Q;const[a,d]=l.useState(null),[N,b]=l.useState(!0),[i,E]=l.useState(null),[u,W]=l.useState("story"),[q,$]=l.useState(!1),[O,I]=l.useState(""),[F,Y]=l.useState(""),[v,K]=l.useState(1),[_,X]=l.useState(""),[S,Z]=l.useState(""),[o,h]=l.useState({status:"idle",valid:!1,participant:null,code:""});l.useEffect(()=>{const t="local-pizza-by-local-effort-let-s-make-1000-pizzas",r=`*[_type == "crowdfundingCampaign" && slug.current == $slug][0]{
      title,
      // Short description: prefer new field name, fallback to legacy if present
      "description": coalesce(description, shortDescription),
      // pizza-specific fields (keep legacy fields for backwards compatibility)
      pizzaGoal,
      pizzasSold,
      piesSold,
      goal,
      raisedAmount,
      backers,
      endDate,
      heroImage,
      story,
      goals,
      faq,
  "rewardTiers": rewardTiers[]->{ amount, pizzaCount, pieCount, title, description, limit, referralOnly, referralCode } | order(amount asc),
      "updates": updates[]->{ title, publishedAt, body } | order(publishedAt desc)
    }`,n={slug:t};(async()=>{try{const c=await P.fetch(r,n);d(c)}catch(c){try{const m=c&&c.message?c.message:String(c);if(console.error("Sanity fetch error message:",m),c&&c.response&&typeof c.response.text=="function"){const x=await c.response.text();console.error("Sanity fetch response body:",x)}}catch(m){console.error("Error while logging Sanity error:",m)}try{const x=await P.fetch(`*[_type == "crowdfundingCampaign"][0]{
            title,
            "description": coalesce(description, shortDescription),
            pizzaGoal,
            pizzasSold,
            piesSold,
            goal,
            raisedAmount,
            backers,
            endDate,
            heroImage,
            story,
            goals,
            faq,
            "rewardTiers": rewardTiers[]->{ amount, pizzaCount, pieCount, title, description, limit, referralOnly, referralCode } | order(amount asc),
            "updates": updates[]->{ title, publishedAt, body } | order(publishedAt desc)
          }`);if(x){console.warn("Loaded fallback campaign (first in dataset)"),d(x),E(null);return}}catch(m){console.error("Fallback fetch also failed:",m&&(m.message||m))}E("Failed to load campaign data.")}finally{b(!1)}})()},[]);const D=(a==null?void 0:a.rewardTiers)||[],z=l.useMemo(()=>{const t=o.valid&&o.code;return D.filter(r=>r!=null&&r.referralOnly?t?r.referralCode&&typeof r.referralCode=="string"?r.referralCode.trim().toLowerCase()===o.code.trim().toLowerCase():!0:!1:!0)},[D,o]),f=l.useMemo(()=>z.find(t=>typeof(t==null?void 0:t.amount)=="number"&&t.amount>0)||null,[z]);if(l.useEffect(()=>{new URLSearchParams(window.location.search).get("payment")==="success"&&(async()=>{try{const r=localStorage.getItem("cf_items"),n=r?JSON.parse(r):[],A=localStorage.getItem("cf_name")||void 0;Array.isArray(n)&&n.length>0&&(await fetch("/api/crowdfund/confirm-payment",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:n,funderName:A})})).ok&&X("Thanks! Your contribution has been recorded.")}catch{}finally{try{localStorage.removeItem("cf_items"),localStorage.removeItem("cf_name")}catch{}}})()},[]),N)return e.createElement("div",{className:"text-center p-12"},"Loading campaign...");if(i){const t=typeof i=="string"?i:i&&(i.message||JSON.stringify(i))||"Failed to load campaign data.";return e.createElement("div",{className:"text-center p-12 text-red-600"},t)}if(!a)return e.createElement("div",{className:"text-center p-12"},"No campaign found. Have you created and published it in Sanity Studio?");const{title:w="Untitled Campaign",description:g=[],backers:ee=0,endDate:M=null,heroImage:R=null}=a,te=a.piesSold??0,j=a.story||[],U=a.faq||[],G=async t=>{I(""),$(!0);try{try{localStorage.setItem("cf_items",JSON.stringify(t)),localStorage.setItem("cf_name",F||"")}catch{}const r=await fetch("/api/crowdfund/contribute",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:t})}),n=await r.json();if(!r.ok||!(n!=null&&n.url))throw new Error((n==null?void 0:n.error)||"Failed to create checkout");window.location.href=n.url}catch(r){I((r==null?void 0:r.message)||"Payment link failed")}finally{$(!1)}},C=a.updates||[],J=(a.pizzasSold??a.raisedAmount)||0,k=(a.pizzaGoal??a.goal)||1e3,T=M?Math.ceil((new Date(M)-new Date)/(1e3*60*60*24)):0,ae=k>0?Math.min(J/k*100,100):0,y=({tabName:t,label:r})=>e.createElement("button",{type:"button",onClick:()=>W(t),"aria-pressed":u===t,className:"tab"},r);y.propTypes={tabName:s.string.isRequired,label:s.string.isRequired};const re=t=>t?typeof t=="string"?t:(t||[]).filter(Boolean).map(r=>typeof r=="string"?r:r.children&&Array.isArray(r.children)?r.children.map(n=>n.text||"").join(""):"").join(`
`).trim():"",B=t=>Array.isArray(t)?t:t?[{_type:"block",style:"normal",children:[{_type:"span",text:typeof t=="string"?t:String(t)}]}]:[];return e.createElement(e.Fragment,null,e.createElement(ne,null,e.createElement("title",null,`${w} | Crowdfunding Campaign`),e.createElement("meta",{name:"description",content:re(g).slice(0,160)})),e.createElement("div",{className:"space-y-16 mx-auto max-w-6xl px-4 md:px-6 lg:px-8"},e.createElement("div",null,e.createElement("h1",{className:"text-4xl md:text-6xl font-bold uppercase tracking-[-0.02em] leading-[1.02]"},w),e.createElement("div",{className:"mt-6 md:mt-8 text-body max-w-2xl"},g&&(Array.isArray(g)?e.createElement(p,{value:g}):e.createElement(p,{value:B(g)})))),e.createElement("div",{className:"grid grid-cols-1 lg:grid-cols-5 lg:gap-16"},e.createElement("div",{className:"lg:col-span-3 space-y-8"},R&&e.createElement("img",{src:oe(R).width(1200).quality(80).url(),alt:w,className:"w-full object-cover rounded-lg aspect-video bg-gray-100"}),e.createElement("div",{className:"border-b border-neutral-200"},e.createElement("nav",{className:"tablist"},e.createElement(y,{tabName:"story",label:"Our Story"}),C.length>0&&e.createElement(y,{tabName:"updates",label:`Updates (${C.length})`}),e.createElement(y,{tabName:"goals",label:"Goals"}),U.length>0&&e.createElement(y,{tabName:"faq",label:"FAQ"}))),e.createElement("div",{className:"prose max-w-none text-body"},u==="story"&&j.length>0&&e.createElement(p,{value:j}),u==="updates"&&e.createElement("div",{className:"space-y-8"},C.map((t,r)=>e.createElement("div",{key:r,className:"p-4 border-l-4 border-gray-200"},e.createElement("div",{className:"mt-0"},e.createElement(H,{overline:"Update",title:t.title})),e.createElement("p",{className:"text-sm text-gray-500 mb-2"},new Date(t.publishedAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})),e.createElement(p,{value:t.body})))),u==="goals"&&e.createElement("div",{className:"space-y-6"},a.goals?Array.isArray(a.goals)?e.createElement(p,{value:a.goals}):e.createElement(p,{value:B(a.goals)}):e.createElement("p",{className:"text-gray-500"},"No goals content yet. Add content in the Goals field in Sanity Studio.")),u==="faq"&&e.createElement("div",{className:"space-y-6"},U.map((t,r)=>e.createElement("div",{key:r},e.createElement("h4",{className:"font-bold text-lg mb-1"},t.question),e.createElement("p",{className:"mt-0"},t.answer)))))),e.createElement("div",{className:"lg:col-span-2 space-y-8 mt-12 lg:mt-0"},e.createElement("div",{className:"card p-6 space-y-4 ring-1 ring-neutral-200"},e.createElement("div",{className:"w-full bg-gray-200 rounded-full h-2.5"},e.createElement("div",{className:"bg-[var(--color-accent)] h-2.5 rounded-full",style:{width:`${ae}%`}})),e.createElement("div",null,e.createElement("p",{className:"text-4xl font-bold text-[var(--color-accent)]"},J.toLocaleString()," pizzas"),e.createElement("p",{className:"text-body text-gray-600"},"sold of ",k.toLocaleString()," pizzas goal"),e.createElement("p",{className:"mt-2 text-2xl font-semibold"},te.toLocaleString()," pies"),e.createElement("p",{className:"text-body text-gray-600"},"sold")),e.createElement("div",{className:"flex justify-between text-body text-center border-y py-3"},e.createElement(L,{value:ee.toLocaleString(),label:"backers"}),e.createElement(L,{value:T>0?T:"Ended",label:T>0?"days to go":""})),_&&e.createElement("p",{className:"text-sm text-emerald-700"},_),O&&e.createElement("p",{className:"text-sm text-red-600"},O),e.createElement("div",{className:"flex flex-col gap-2"},e.createElement("input",{id:"cf-name",className:"input w-full",placeholder:"Name",value:F,onChange:t=>Y(t.target.value)})),e.createElement("div",{className:"flex items-center gap-2"},e.createElement("input",{className:"input flex-1",placeholder:"Have a referral code?",value:S,onChange:t=>Z(t.target.value)}),e.createElement("button",{type:"button",className:"btn btn-secondary",disabled:!S||o.status==="checking",onClick:async()=>{const t=(S||"").trim();if(t){h({status:"checking",valid:!1,participant:null,code:t});try{const r=await fetch("/api/referrals/validate",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:t})}),n=await r.json().catch(()=>({}));r.ok&&n&&n.valid?h({status:"ok",valid:!0,participant:n.participant||null,code:t}):h({status:"ok",valid:!1,participant:null,code:t})}catch{h({status:"error",valid:!1,participant:null,code:t})}}}},o.status==="checking"?"Checking…":"Apply")),o.status==="ok"&&o.valid&&e.createElement("p",{className:"text-sm text-emerald-700"},"Code applied",(Q=o.participant)!=null&&Q.name?` for ${o.participant.name}`:"","."),o.status==="ok"&&!o.valid&&e.createElement("p",{className:"text-sm text-red-600"},"That code is not valid."),f&&e.createElement("div",{className:"flex items-center gap-3"},e.createElement("label",{htmlFor:"pizza-qty",className:"text-sm"},"Quantity"),e.createElement("input",{id:"pizza-qty",type:"number",min:1,max:50,value:v,onChange:t=>K(Math.max(1,Math.min(50,Number(t.target.value)||1))),className:"input w-24"})),e.createElement("button",{disabled:!f,onClick:()=>f&&G([{name:f.title||"Pizza",price:f.amount,type:"pizza",pizzaCount:v,quantity:v}]),className:"btn btn-primary w-full text-lg py-3 disabled:opacity-60"},q?"Preparing checkout…":"i want pizza")),e.createElement("div",{className:"space-y-4"},e.createElement(H,{overline:"Contribute",title:"Support Us"}),z.map(t=>e.createElement(V,{key:(t==null?void 0:t.title)||Math.random(),tier:t,busy:q,onContribute:r=>G([r])})))))))};export{pe as default};
