import{e as $,h as T,r as c,R as e,c as Q,W as z,m as B}from"./index-BB2wScGM.js";import{P as V}from"./index-CVnwnSTj.js";function K(...t){const k=[],o=h=>{h&&k.push(String(h))},y=h=>{for(const d of h){const f=typeof d;if(d){if(f==="string"||f==="number"){o(d);continue}if(Array.isArray(d)){y(d);continue}if(f==="object")for(const E in d)Object.prototype.hasOwnProperty.call(d,E)&&d[E]&&o(E)}}};return y(t),k.join(" ")}function R(...t){return K(...t)}function U({product:t}){var C;const{add:k,map:o,updateQty:y,open:h,openCart:d}=$(),{notify:f}=T(),[E,N]=c.useState(0),[m,l]=c.useState(!1),w=c.useRef(null),P=c.useRef(null),I=c.useRef(null),D=Array.isArray(t.variants)&&t.variants.length>0,g=D?t.variants[Math.max(0,Math.min(E,t.variants.length-1))]:null,_=(g==null?void 0:g.price)??t.salePrice??t.price,p=c.useMemo(()=>(Array.isArray(t==null?void 0:t.images)?t.images:[]).map(a=>{var i;return typeof a=="string"?a:(a==null?void 0:a.url)||((i=a==null?void 0:a.asset)==null?void 0:i.url)||null}).filter(Boolean),[t]),v=p[0],u=p.slice(1),j=c.useMemo(()=>`variant-select-${t.id||"p"}`,[t.id]),M=()=>{var b;const r=(g==null?void 0:g.squareVariationId)||t.squareVariationId||null,a=`${t.id}:${r||""}`,i=((b=o==null?void 0:o[a])==null?void 0:b.qty)||0;t.inventoryManaged&&(typeof t.inventory=="number"?t.inventory:1/0)-i<=0||(k({productId:t.id,variationId:r,unitPrice:_,qty:1,title:t.title,image:v}),f("Added to cart",{actionLabel:h?void 0:"View cart",onAction:h?void 0:d}))},n=`${t.id}:${(g==null?void 0:g.squareVariationId)||t.squareVariationId||""}`,s=((C=o==null?void 0:o[n])==null?void 0:C.qty)||0,x=c.useMemo(()=>`$${(_/100).toFixed(2)}`,[_]);return c.useEffect(()=>{if(!m)return;I.current=document.activeElement;const r=w.current;if(P.current)try{P.current.focus()}catch{}const a=i=>{if(i.key==="Escape"){i.stopPropagation(),l(!1);return}if(i.key==="Tab"&&r){const b=r.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'),S=Array.from(b).filter(O=>O.offsetParent!==null);if(S.length===0)return;const F=S[0],A=S[S.length-1];!i.shiftKey&&document.activeElement===A?(i.preventDefault(),F.focus()):i.shiftKey&&document.activeElement===F&&(i.preventDefault(),A.focus())}};return document.addEventListener("keydown",a,!0),()=>{document.removeEventListener("keydown",a,!0);const i=I.current;if(i&&i.focus)try{i.focus()}catch{}}},[m]),e.createElement("div",{className:R("group relative rounded-xl border border-neutral-200 bg-white shadow-sm overflow-hidden","transition hover:shadow-md")},e.createElement("div",{className:"relative aspect-[4/3] w-full bg-neutral-100 overflow-hidden cursor-pointer",role:"button",tabIndex:0,onClick:()=>l(!0),onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),l(!0))}},v?e.createElement(e.Fragment,null,e.createElement("img",{src:v,alt:t.title,loading:"lazy",className:R("absolute inset-0 h-full w-full object-cover",u[0]?"transition-opacity duration-300 opacity-100 group-hover:opacity-0":"")}),u[0]?e.createElement("img",{src:u[0],alt:"","aria-hidden":"true",loading:"lazy",className:"absolute inset-0 h-full w-full object-cover transition-opacity duration-300 opacity-0 group-hover:opacity-100"}):null,e.createElement("div",{className:R("pointer-events-none absolute inset-x-0 bottom-0 transition-opacity duration-200","opacity-0 group-hover:opacity-100 group-focus-within:opacity-100")},e.createElement("div",{className:"pointer-events-none bg-gradient-to-t from-black/70 to-transparent text-white p-3"},t.shortDescription?e.createElement("p",{className:"text-xs leading-snug line-clamp-2"},t.shortDescription):null))):e.createElement("div",{className:"w-full h-full grid place-items-center text-neutral-400"},"No image")),e.createElement("div",{className:"p-3"},e.createElement("div",{className:"flex items-baseline justify-between gap-3"},e.createElement("h3",{className:"text-base font-semibold leading-tight line-clamp-2"},e.createElement("button",{type:"button",className:"text-left w-full cursor-pointer hover:underline focus:outline-none",onClick:()=>l(!0)},t.title)),e.createElement("div",{className:"text-sm font-mono"},t.salePrice&&e.createElement("span",{className:"text-neutral-400 line-through mr-1"},"$",(t.price/100).toFixed(2)),e.createElement("span",{className:"text-rose-600 font-bold"},x))),t.shortDescription&&e.createElement("p",{className:"text-sm text-neutral-600 mt-1 line-clamp-2"},t.shortDescription),e.createElement("div",{className:"mt-3 flex gap-2 items-center"},D&&e.createElement("select",{className:"input",value:E,onChange:r=>N(Number(r.target.value)||0),"aria-label":"Choose a variant"},t.variants.map((r,a)=>e.createElement("option",{key:r.squareVariationId||r.name||a,value:a},r.name||`Option ${a+1}`))),s>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>y(n,Math.max(0,s-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},s),e.createElement("button",{className:"btn",onClick:()=>y(n,s+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:M,disabled:t.inventoryManaged&&(t.inventory??0)<=s,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=s,title:t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":"Add to cart"},t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":s>0?"Add one more":"Add to cart"))),m&&e.createElement("div",{className:"fixed inset-0 z-[60]","aria-hidden":!m},e.createElement("div",{className:"absolute inset-0 bg-black/50",onClick:()=>l(!1)}),e.createElement("div",{className:"absolute inset-x-3 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 top-10 bottom-10 md:top-1/2 md:-translate-y-1/2 md:bottom-auto w-auto md:w-[720px] max-w-[95vw]",role:"dialog","aria-modal":"true","aria-labelledby":`product-dialog-title-${t.id}`,ref:w},e.createElement("div",{className:"bg-white rounded-xl shadow-2xl border overflow-hidden flex flex-col h-full md:h-auto"},e.createElement("div",{className:"flex items-start justify-between p-4 border-b"},e.createElement("h3",{id:`product-dialog-title-${t.id}`,className:"text-lg font-semibold"},t.title),e.createElement("button",{ref:P,className:"btn",onClick:()=>l(!1),"aria-label":"Close"},"✕")),e.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-4 p-4 overflow-auto"},e.createElement("div",null,v?e.createElement("img",{src:v,alt:t.title,className:"w-full h-56 md:h-72 object-cover rounded"}):e.createElement("div",{className:"w-full h-56 md:h-72 grid place-items-center text-neutral-400 bg-neutral-100 rounded"},"No image"),u.length>0&&e.createElement("div",{className:"mt-2 grid grid-cols-4 gap-2"},[v,...u].slice(0,8).map((r,a)=>e.createElement("div",{key:a,className:"block"},e.createElement("img",{src:r,alt:"",className:"w-full h-16 object-cover rounded"}))))),e.createElement("div",null,e.createElement("div",{className:"text-xl font-semibold"},x),D&&e.createElement("div",{className:"mt-3"},e.createElement("label",{className:"block text-sm font-medium mb-1",htmlFor:j},"Choose an option"),e.createElement("select",{className:"input w-full",id:j,value:E,onChange:r=>N(Number(r.target.value)||0)},t.variants.map((r,a)=>e.createElement("option",{key:r.squareVariationId||r.name||a,value:a},r.name||`Option ${a+1}`)))),Array.isArray(t.longDescriptionBlocks)&&t.longDescriptionBlocks.length>0?e.createElement("div",{className:"prose prose-sm mt-4 max-w-none"},e.createElement(V,{value:t.longDescriptionBlocks})):t.longDescription?e.createElement("p",{className:"text-sm text-neutral-700 mt-4 whitespace-pre-wrap"},t.longDescription):null,e.createElement("div",{className:"mt-6 flex gap-2 items-center"},s>0&&e.createElement("div",{className:"inline-flex items-center gap-2"},e.createElement("button",{className:"btn",onClick:()=>y(n,Math.max(0,s-1)),"aria-label":"Decrease quantity"},"-"),e.createElement("span",{className:"min-w-[2ch] text-center text-sm"},s),e.createElement("button",{className:"btn",onClick:()=>y(n,s+1),"aria-label":"Increase quantity"},"+")),e.createElement("button",{className:"btn btn-primary",onClick:M,disabled:t.inventoryManaged&&(t.inventory??0)<=s,"aria-disabled":t.inventoryManaged&&(t.inventory??0)<=s},t.inventoryManaged&&(t.inventory??0)<=s?"Out of stock":s>0?"Add one more":"Add to cart"))))))))}function J(){const{items:t,subtotal:k,open:o,closeCart:y,clear:h}=$(),[d,f]=c.useState(!1),[E,N]=c.useState(""),[m,l]=c.useState(""),[w,P]=c.useState(""),[I,D]=c.useState(!0),[g,_]=c.useState(""),[p,v]=c.useState({line1:"",line2:"",city:"",state:"",postal:""}),u=e.useRef(null),j=e.useRef(null);e.useEffect(()=>{var C,r,a,i;const n=((r=(C=import.meta)==null?void 0:C.env)==null?void 0:r.VITE_SQUARE_APP_ID)||(window==null?void 0:window.__SQUARE_APP_ID__),s=((i=(a=import.meta)==null?void 0:a.env)==null?void 0:i.VITE_SQUARE_LOCATION_ID)||(window==null?void 0:window.__SQUARE_LOCATION_ID__);if(!o||!t||t.length===0)return;if(N(""),!n||!s){N("Square not configured");return}let x=!1;return(async()=>{try{if(document.getElementById("sq-wpsdk")||await new Promise((A,O)=>{const q=document.createElement("script");q.id="sq-wpsdk",q.src="https://web.squarecdn.com/v1/square.js",q.onload=A,q.onerror=()=>O(new Error("Square SDK failed")),document.head.appendChild(q)}),x)return;await new Promise((A,O)=>{let q=0;const L=setInterval(()=>{q++,window.Square&&typeof window.Square.payments=="function"?(clearInterval(L),A()):q>50&&(clearInterval(L),O(new Error("Square SDK not ready")))},100)});const S=window.Square?window.Square.payments(n,s):null;if(!S)throw new Error("Square payments unavailable");if(u.current&&typeof u.current.destroy=="function"){try{u.current.destroy()}catch{}u.current=null}const F=await S.card();u.current=F,j.current&&await F.attach("#sq-card")}catch(b){N(b!=null&&b.message?`Payment form failed: ${b.message}`:"Payment form failed to load")}})(),()=>{x=!0}},[o,t]),e.useEffect(()=>{if(!o&&u.current&&typeof u.current.destroy=="function"){try{u.current.destroy()}catch{}u.current=null}},[o]);const M=async n=>{var s;n.preventDefault(),f(!0),N("");try{let x=null;if(u.current){const a=await u.current.tokenize();if(a.status!=="OK"){const i=(a==null?void 0:a.errors)&&((s=a.errors[0])==null?void 0:s.message)||(a==null?void 0:a.status)||"Card details invalid";throw new Error(i)}x=a.token}const C=await fetch("/api/store/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer:{name:m,email:w,phone:g},pickup:I,address:I?null:p,items:t.map(a=>({productId:a.productId,variationId:a.variationId,qty:a.qty,unitPrice:a.unitPrice,title:a.title})),token:x})}),r=await C.json();if(!C.ok)throw new Error(r.error||"Checkout failed");h(),y(),alert("Order placed!")}catch(x){N(x.message||"Checkout failed")}finally{f(!1)}};return o?e.createElement("div",{className:"fixed inset-0 bg-black/40 z-50"},e.createElement("div",{className:"absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-xl p-4 overflow-auto"},e.createElement("div",{className:"flex items-center justify-between mb-3"},e.createElement("h3",{className:"text-xl font-semibold"},"Your Cart"),e.createElement("button",{className:"btn",onClick:y},"Close")),t.length===0?e.createElement("p",{className:"text-sm text-neutral-600"},"Your cart is empty."):e.createElement(e.Fragment,null,e.createElement("ul",{className:"divide-y"},t.map(n=>e.createElement("li",{key:n.key,className:"py-2 flex items-center gap-3"},n.image&&e.createElement("img",{src:n.image,alt:"",className:"w-12 h-12 object-cover rounded"}),e.createElement("div",{className:"flex-1"},e.createElement("div",{className:"font-medium text-sm"},n.title),e.createElement("div",{className:"text-xs text-neutral-600"},"Qty ",n.qty," • $",(n.unitPrice/100).toFixed(2)))))),e.createElement("div",{className:"mt-4 border-t pt-3"},e.createElement("div",{className:"flex justify-between text-sm"},e.createElement("span",null,"Subtotal"),e.createElement("span",null,"$",(k/100).toFixed(2))),e.createElement("p",{className:"text-xs text-neutral-500 mt-1"},"Tax calculated by Square.")),e.createElement("form",{onSubmit:M,className:"mt-4 space-y-3"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-name"},"Name"),e.createElement("input",{id:"co-name",className:"input w-full",value:m,onChange:n=>l(n.target.value),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-email"},"Email"),e.createElement("input",{id:"co-email",type:"email",className:"input w-full",value:w,onChange:n=>P(n.target.value),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"co-phone"},"Phone"),e.createElement("input",{id:"co-phone",type:"tel",className:"input w-full",value:g,onChange:n=>_(n.target.value)})),e.createElement("div",{className:"flex items-center gap-2 text-sm"},e.createElement("input",{id:"pickup",type:"checkbox",checked:I,onChange:n=>D(n.target.checked)}),e.createElement("label",{htmlFor:"pickup"},"Pickup / local service")),!I&&e.createElement("div",{className:"grid grid-cols-1 gap-2"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"addr1"},"Address line 1"),e.createElement("input",{id:"addr1",className:"input w-full",value:p.line1,onChange:n=>v({...p,line1:n.target.value}),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"addr2"},"Address line 2 (optional)"),e.createElement("input",{id:"addr2",className:"input w-full",value:p.line2,onChange:n=>v({...p,line2:n.target.value})})),e.createElement("div",{className:"grid grid-cols-2 gap-2"},e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"city"},"City"),e.createElement("input",{id:"city",className:"input w-full",value:p.city,onChange:n=>v({...p,city:n.target.value}),required:!0})),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"state"},"State"),e.createElement("input",{id:"state",className:"input w-full",value:p.state,onChange:n=>v({...p,state:n.target.value}),required:!0}))),e.createElement("div",null,e.createElement("label",{className:"label",htmlFor:"zip"},"Postal code"),e.createElement("input",{id:"zip",className:"input w-full",value:p.postal,onChange:n=>v({...p,postal:n.target.value}),required:!0}))),e.createElement("div",{className:"rounded-md border p-3 text-sm text-neutral-600"},e.createElement("div",{id:"sq-card",ref:j,className:"min-h-[52px]"})),E&&e.createElement("div",{className:"text-sm text-red-600"},E),e.createElement("button",{type:"submit",className:"btn btn-primary w-full",disabled:d},d?"Processing…":"Checkout"))))):null}const G=()=>{const{totalQty:t,openCart:k}=$(),[o,y]=c.useState([]),[h,d]=c.useState(!0),[f,E]=c.useState({subheading:"",intro:[]});c.useEffect(()=>{let m=!0;return(async()=>{try{const l=await fetch("/api/store/products"),w=l.ok?await l.json():{products:[]};if(!m)return;y(Array.isArray(w.products)?w.products:[])}catch{if(!m)return;y([])}finally{m&&d(!1)}})(),(async()=>{try{const l=await Q.fetch('*[_type == "salePage"][0]{ subheading, intro }').catch(()=>null);if(!m)return;l&&E({subheading:l.subheading||"",intro:Array.isArray(l.intro)?l.intro:[]})}catch{}})(),()=>{m=!1}},[]);const N=c.useMemo(()=>({"@context":"https://schema.org","@type":"ItemList",name:"Sale",itemListElement:(o||[]).map((l,w)=>({"@type":"ListItem",position:w+1,item:{"@type":"Product",name:l.title,image:Array.isArray(l.images)?l.images.filter(Boolean):l.images?[l.images]:[],description:l.shortDescription,sku:l.squareVariationId||l.squareItemId||l.id,offers:{"@type":"Offer",priceCurrency:"USD",price:(l.salePrice??l.price)/100,availability:"https://schema.org/InStock"}}}))}),[o]);return e.createElement("div",{className:"mx-auto max-w-6xl px-4 md:px-6 lg:px-8 py-8"},e.createElement(z,null,e.createElement("title",null,"SALE | Local Effort"),e.createElement("meta",{name:"description",content:"Shop Local Effort sale items. Pickup/local service with on-site checkout."}),e.createElement("link",{rel:"canonical",href:"https://localeffortfood.com/sale"}),e.createElement("script",{type:"application/ld+json"},JSON.stringify(N))),e.createElement("div",{className:"flex items-start justify-between mb-4 gap-4"},e.createElement("div",null,e.createElement("h1",{className:"text-3xl font-bold tracking-tight"},"Sale"),f.subheading&&e.createElement("p",{className:"mt-1 text-neutral-700"},f.subheading),Array.isArray(f.intro)&&f.intro.length>0&&e.createElement("div",{className:"prose prose-neutral max-w-none mt-3"},e.createElement(V,{value:f.intro}))),e.createElement("button",{onClick:k,className:"btn btn-primary whitespace-nowrap"},"Cart (",t,")")),h?e.createElement("div",null,"Loading…"):e.createElement("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"},(o||[]).map(m=>e.createElement(B.div,{key:m.id,initial:{opacity:0,y:8},whileInView:{opacity:1,y:0},viewport:{once:!0}},e.createElement(U,{product:m})))),e.createElement(J,null))};export{G as default};
